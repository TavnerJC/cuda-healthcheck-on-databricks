name: Compatibility Matrix Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  compatibility-matrix:
    name: Runtime ${{ matrix.runtime }} + torch ${{ matrix.torch_variant }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue testing all combinations even if one fails
      matrix:
        runtime: ["14.3", "15.1", "15.2"]
        torch_variant: ["cu120", "cu121", "cu124"]
        include:
          # Define expected behavior for each combination
          - runtime: "14.3"
            torch_variant: "cu120"
            expected_result: "pass"
            driver: "535"
            cuda: "12.0"
          - runtime: "14.3"
            torch_variant: "cu121"
            expected_result: "pass"
            driver: "535"
            cuda: "12.0"
          - runtime: "14.3"
            torch_variant: "cu124"
            expected_result: "fail"  # Known incompatibility
            driver: "535"
            cuda: "12.0"
          - runtime: "15.1"
            torch_variant: "cu120"
            expected_result: "pass"
            driver: "550"
            cuda: "12.4"
          - runtime: "15.1"
            torch_variant: "cu121"
            expected_result: "pass"
            driver: "550"
            cuda: "12.4"
          - runtime: "15.1"
            torch_variant: "cu124"
            expected_result: "pass"
            driver: "550"
            cuda: "12.4"
          - runtime: "15.2"
            torch_variant: "cu120"
            expected_result: "pass"
            driver: "550"
            cuda: "12.4"
          - runtime: "15.2"
            torch_variant: "cu121"
            expected_result: "pass"
            driver: "550"
            cuda: "12.4"
          - runtime: "15.2"
            torch_variant: "cu124"
            expected_result: "pass"
            driver: "550"
            cuda: "12.4"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-mock

    - name: Create mock pip freeze output
      run: |
        mkdir -p test_artifacts
        cat > test_artifacts/mock_pip_freeze_${{ matrix.runtime }}_${{ matrix.torch_variant }}.txt << 'EOF'
        torch==2.4.1+${{ matrix.torch_variant }}
        nvidia-cublas-cu12==12.4.5.8
        nvidia-nvjitlink-cu12==12.4.127
        nvidia-cuda-runtime-cu12==12.4.127
        numpy==1.26.4
        pandas==2.0.0
        EOF

    - name: Create test script
      run: |
        cat > test_artifacts/test_compatibility_${{ matrix.runtime }}_${{ matrix.torch_variant }}.py << 'EOF'
        """
        Compatibility test for Runtime ${{ matrix.runtime }} + torch ${{ matrix.torch_variant }}
        Expected result: ${{ matrix.expected_result }}
        """
        import os
        import sys
        from cuda_healthcheck.utils import (
            parse_cuda_packages,
            validate_torch_branch_compatibility
        )

        def test_compatibility():
            print(f"\n{'='*80}")
            print(f"Testing: Runtime ${{ matrix.runtime }} + torch ${{ matrix.torch_variant }}")
            print(f"Expected: ${{ matrix.expected_result }}")
            print(f"{'='*80}\n")

            # Read mock pip freeze
            with open("test_artifacts/mock_pip_freeze_${{ matrix.runtime }}_${{ matrix.torch_variant }}.txt", "r") as f:
                pip_output = f.read()

            # Parse packages
            packages = parse_cuda_packages(pip_output)
            torch_version = packages.get("torch")
            torch_cuda_branch = packages.get("torch_cuda_branch")

            print(f"Detected PyTorch: {torch_version}")
            print(f"Detected CUDA branch: {torch_cuda_branch}")

            # Validate compatibility
            result = validate_torch_branch_compatibility(
                runtime_version=float(${{ matrix.runtime }}),
                torch_cuda_branch=torch_cuda_branch
            )

            print(f"\nCompatibility check result:")
            print(f"  is_compatible: {result['is_compatible']}")
            print(f"  severity: {result.get('severity', 'None')}")

            if result.get("issue"):
                print(f"  issue: {result['issue']}")

            if result.get("fix_options"):
                print(f"  fix_options: {len(result['fix_options'])} option(s)")

            # Validate expected behavior
            expected_pass = "${{ matrix.expected_result }}" == "pass"
            actual_pass = result["is_compatible"]

            print(f"\nValidation:")
            print(f"  Expected to pass: {expected_pass}")
            print(f"  Actually passed: {actual_pass}")

            if expected_pass == actual_pass:
                print(f"  âœ… Test PASSED - Behavior matches expectation")
                return 0
            else:
                print(f"  âŒ Test FAILED - Unexpected behavior!")
                return 1

        if __name__ == "__main__":
            sys.exit(test_compatibility())
        EOF

    - name: Run compatibility test
      id: test
      continue-on-error: true
      run: |
        python test_artifacts/test_compatibility_${{ matrix.runtime }}_${{ matrix.torch_variant }}.py > test_artifacts/output_${{ matrix.runtime }}_${{ matrix.torch_variant }}.log 2>&1
        TEST_EXIT_CODE=$?
        cat test_artifacts/output_${{ matrix.runtime }}_${{ matrix.torch_variant }}.log
        
        # Create result file
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "PASS" > test_artifacts/result_${{ matrix.runtime }}_${{ matrix.torch_variant }}.txt
        else
          echo "FAIL" > test_artifacts/result_${{ matrix.runtime }}_${{ matrix.torch_variant }}.txt
        fi
        
        exit $TEST_EXIT_CODE

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.runtime }}-${{ matrix.torch_variant }}
        path: test_artifacts/
        retention-days: 30

    - name: Set job status
      if: always()
      run: |
        if [ "${{ steps.test.outcome }}" = "success" ]; then
          echo "âœ… Runtime ${{ matrix.runtime }} + torch ${{ matrix.torch_variant }}: PASSED"
        else
          echo "âŒ Runtime ${{ matrix.runtime }} + torch ${{ matrix.torch_variant }}: FAILED"
        fi

  generate-report:
    name: Generate Compatibility Report
    runs-on: ubuntu-latest
    needs: compatibility-matrix
    if: always()
    permissions:
      pull-requests: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: all_test_results

    - name: Generate compatibility matrix report
      id: generate_report
      run: |
        mkdir -p report
        
        cat > report/compatibility_matrix.md << 'EOFMD'
        # ðŸ§ª Compatibility Matrix Test Results

        ## Test Configuration

        **Workflow Run:** ${{ github.run_number }}  
        **Commit:** ${{ github.sha }}  
        **Branch:** ${{ github.ref_name }}  
        **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ---

        ## Compatibility Matrix

        | Runtime | Driver | CUDA | cu120 | cu121 | cu124 |
        |---------|--------|------|-------|-------|-------|
        EOFMD

        # Function to check result
        check_result() {
          runtime=$1
          variant=$2
          result_file="all_test_results/test-results-${runtime}-${variant}/result_${runtime}_${variant}.txt"
          
          if [ -f "$result_file" ]; then
            result=$(cat "$result_file")
            if [ "$result" = "PASS" ]; then
              echo "âœ…"
            else
              echo "âŒ"
            fi
          else
            echo "âš ï¸"
          fi
        }

        # Generate matrix rows
        echo "| 14.3    | 535    | 12.0 | $(check_result 14.3 cu120) | $(check_result 14.3 cu121) | $(check_result 14.3 cu124) |" >> report/compatibility_matrix.md
        echo "| 15.1    | 550    | 12.4 | $(check_result 15.1 cu120) | $(check_result 15.1 cu121) | $(check_result 15.1 cu124) |" >> report/compatibility_matrix.md
        echo "| 15.2    | 550    | 12.4 | $(check_result 15.2 cu120) | $(check_result 15.2 cu121) | $(check_result 15.2 cu124) |" >> report/compatibility_matrix.md

        cat >> report/compatibility_matrix.md << 'EOFMD'

        **Legend:**
        - âœ… Compatible (as expected)
        - âŒ Incompatible (as expected) or Test failed unexpectedly
        - âš ï¸ Test did not run or result unavailable

        ---

        ## Expected Behavior

        ### âœ… Compatible Combinations (8/9)

        All combinations should work EXCEPT Runtime 14.3 + cu124:

        - **Runtime 14.3** (Driver 535, CUDA 12.0)
          - âœ… cu120: Compatible
          - âœ… cu121: Compatible
          - âŒ cu124: **INCOMPATIBLE** (Driver 535 < required 550)

        - **Runtime 15.1** (Driver 550, CUDA 12.4)
          - âœ… cu120: Compatible
          - âœ… cu121: Compatible
          - âœ… cu124: Compatible

        - **Runtime 15.2** (Driver 550, CUDA 12.4)
          - âœ… cu120: Compatible
          - âœ… cu121: Compatible
          - âœ… cu124: Compatible

        ### âŒ Known Incompatibility

        **Runtime 14.3 + torch cu124** is intentionally incompatible:

        - **Root cause:** Driver 535 (immutable on Runtime 14.3) < 550 (required by cu124)
        - **Detection:** Tool should flag as BLOCKER
        - **Fix options:**
          1. Downgrade PyTorch to cu120 or cu121
          2. Upgrade Databricks runtime to 15.1 or 15.2+

        ---

        ## Detailed Test Results

        EOFMD

        # Add detailed results for each combination
        for runtime in "14.3" "15.1" "15.2"; do
          for variant in "cu120" "cu121" "cu124"; do
            echo "" >> report/compatibility_matrix.md
            echo "### Runtime ${runtime} + torch ${variant}" >> report/compatibility_matrix.md
            echo "" >> report/compatibility_matrix.md
            
            log_file="all_test_results/test-results-${runtime}-${variant}/output_${runtime}_${variant}.log"
            if [ -f "$log_file" ]; then
              echo "\`\`\`" >> report/compatibility_matrix.md
              cat "$log_file" >> report/compatibility_matrix.md
              echo "\`\`\`" >> report/compatibility_matrix.md
            else
              echo "*Test output not available*" >> report/compatibility_matrix.md
            fi
            echo "" >> report/compatibility_matrix.md
          done
        done

        cat >> report/compatibility_matrix.md << 'EOFMD'

        ---

        ## Summary

        This automated test validates that the CUDA Healthcheck Tool correctly:

        1. âœ… Detects compatible runtime + torch combinations
        2. âŒ Flags the known incompatibility (Runtime 14.3 + cu124)
        3. ðŸ“‹ Provides appropriate fix options for incompatible combinations
        4. ðŸŽ¯ Correctly identifies all 9 combinations in the compatibility matrix

        **Test Automation:** This workflow runs on every push and PR to ensure compatibility detection remains accurate.

        ---

        **ðŸ“Š Test Coverage:** 9/9 combinations tested (100%)  
        **ðŸ”— Full Results:** [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        EOFMD

        # Output for next step
        cat report/compatibility_matrix.md

    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: compatibility-report
        path: report/
        retention-days: 90

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('report/compatibility_matrix.md', 'utf8');
          
          // Find existing comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ§ª Compatibility Matrix Test Results')
          );
          
          const commentBody = report;
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Create summary
      if: always()
      run: |
        cat report/compatibility_matrix.md >> $GITHUB_STEP_SUMMARY

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [compatibility-matrix, generate-report]
    if: always()

    steps:
    - name: Check matrix results
      run: |
        echo "## Compatibility Matrix Testing Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All 9 runtime + torch combinations have been tested." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Download the full compatibility report from the artifacts." >> $GITHUB_STEP_SUMMARY
        echo "âœ… View detailed results in the generate-report job output." >> $GITHUB_STEP_SUMMARY

